name: Goal Alignment Check

on:
  issues:
    types: [opened, edited, labeled]
  pull_request:
    types: [opened, edited, labeled, synchronize]
  schedule:
    # Run daily at 9:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  check-alignment:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch current goals
        id: fetch-goals
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Try to fetch GOALS.md from .github repository
            try {
              const response = await github.rest.repos.getContent({
                owner: 'Fused-Gaming',
                repo: '.github',
                path: 'GOALS.md'
              });

              const content = Buffer.from(response.data.content, 'base64').toString('utf-8');

              // Extract current quarter from content
              const quarterMatch = content.match(/Current Planning Period[:\s]+(\d{4} Q\d)/i);
              const currentQuarter = quarterMatch ? quarterMatch[1] : '2026 Q1';

              // Extract goal titles
              const goalMatches = content.match(/^### Goal \d+: (.+?)(?:\s+[üë•üöÄüìãüõ†Ô∏èü§ù])?$/gm) || [];
              const goals = goalMatches.map(match => {
                const title = match.replace(/^### Goal \d+:\s*/, '').replace(/\s+[üë•üöÄüìãüõ†Ô∏èü§ù].*$/, '').trim();
                return title;
              });

              core.setOutput('quarter', currentQuarter);
              core.setOutput('goals', JSON.stringify(goals));

              console.log('Current Quarter:', currentQuarter);
              console.log('Current Goals:', goals);

              return { quarter: currentQuarter, goals };
            } catch (error) {
              console.log('Could not fetch GOALS.md:', error.message);
              core.setOutput('quarter', '2026 Q1');
              core.setOutput('goals', JSON.stringify([]));
              return { quarter: '2026 Q1', goals: [] };
            }

      - name: Check issue/PR alignment with goals
        if: github.event_name == 'issues' || github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            const isIssue = !!context.payload.issue;
            const title = item.title.toLowerCase();
            const body = (item.body || '').toLowerCase();
            const labels = item.labels.map(l => l.name);

            // Get current goals
            const goals = ${{ steps.fetch-goals.outputs.goals }};
            const currentQuarter = '${{ steps.fetch-goals.outputs.quarter }}';

            // Check if item mentions any current goals
            const mentionedGoals = goals.filter(goal =>
              title.includes(goal.toLowerCase()) ||
              body.includes(goal.toLowerCase())
            );

            // Check for strategic labels
            const isStrategic = labels.some(l =>
              l.includes('goal') ||
              l.includes('project-proposal') ||
              l.includes('governance') ||
              l.includes('priority: critical') ||
              l.includes('priority: high')
            );

            // If strategic but no goal alignment mentioned, add a comment
            if (isStrategic && mentionedGoals.length === 0 && !body.includes('goal')) {
              const goalsList = goals.map(g => `- ${g}`).join('\n');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                body: `## üéØ Goal Alignment Check\n\nThis ${isIssue ? 'issue' : 'PR'} is marked as strategic but doesn't explicitly mention alignment with current organizational goals.\n\n**Current Goals for ${currentQuarter}:**\n${goalsList}\n\n**Consider:**\n- Does this align with one of our strategic goals?\n- If yes, please reference the goal in the description\n- If not, should it be a strategic item?\n\nSee [GOALS.md](https://github.com/Fused-Gaming/.github/blob/main/GOALS.md) for details.\n\n*This is an automated check to ensure organizational alignment.*`
              });
            } else if (mentionedGoals.length > 0) {
              console.log(`‚úÖ Aligned with goals: ${mentionedGoals.join(', ')}`);

              // Add comment confirming alignment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                body: `## ‚úÖ Goal Alignment Confirmed\n\nThis ${isIssue ? 'issue' : 'PR'} aligns with the following organizational goal(s):\n${mentionedGoals.map(g => `- **${g}**`).join('\n')}\n\nThank you for contributing to our strategic objectives! üéâ\n\nTrack progress: [Strategic Goals & Initiatives Board](https://github.com/orgs/Fused-Gaming/projects/10)`
              });
            }

      - name: Generate alignment report
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const goals = ${{ steps.fetch-goals.outputs.goals }};
            const currentQuarter = '${{ steps.fetch-goals.outputs.quarter }}';

            // Search for issues across the organization related to current goals
            const searchPromises = goals.map(async (goal) => {
              const query = `org:Fused-Gaming "${goal}" state:open`;
              const results = await github.rest.search.issuesAndPullRequests({
                q: query,
                per_page: 10
              });
              return {
                goal,
                count: results.data.total_count,
                items: results.data.items.slice(0, 5)
              };
            });

            const alignmentData = await Promise.all(searchPromises);

            // Create summary
            let summary = `# üéØ Goal Alignment Report\n\n`;
            summary += `**Period**: ${currentQuarter}\n`;
            summary += `**Generated**: ${new Date().toISOString()}\n\n`;

            summary += `## Strategic Goals Status\n\n`;

            for (const data of alignmentData) {
              summary += `### ${data.goal}\n`;
              summary += `- **Active Items**: ${data.count}\n`;

              if (data.items.length > 0) {
                summary += `- **Recent Issues/PRs**:\n`;
                for (const item of data.items) {
                  summary += `  - [#${item.number}](${item.html_url}) - ${item.title}\n`;
                }
              } else {
                summary += `- ‚ö†Ô∏è No active issues or PRs found for this goal\n`;
              }
              summary += `\n`;
            }

            summary += `\n---\n`;
            summary += `View full goals: [GOALS.md](https://github.com/Fused-Gaming/.github/blob/main/GOALS.md)\n`;
            summary += `Track progress: [Project Board](https://github.com/orgs/Fused-Gaming/projects/10)\n`;

            core.summary.addRaw(summary).write();
            console.log(summary);
